<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Startup-Idea Evaluator</title>

  <!-- ——— styles unchanged ——— -->
  <style>
    /* … ( 💡  keep all the CSS from your last version, unchanged ) … */
  </style>
</head>

<body>
  <div class="container">
    <h1>AI Startup-Idea Evaluator</h1>

    <label for="idea">Your Idea</label>
    <textarea id="idea" placeholder="Describe your startup idea in detail..."></textarea>

    <button id="send">Evaluate Idea</button>

    <div id="status"></div>
    <div id="scores" class="metrics"></div>
    <div id="answer"></div>
  </div>

  <script>
    /* ---------- endpoints ---------- */
    const SUBMIT_URL = 'https://benzh88.app.n8n.cloud/webhook/6b09d0aa-a903-4239-a2bb-9cbff340c34a';
    const RESULT_URL = 'https://benzh88.app.n8n.cloud/webhook/a6e524b5-b6f5-452a-a7bd-82771d08c8af/result/';

    /* ---------- helpers ---------- */
    const hslForScore = s => `hsl(${Math.max(0, Math.min(120, s))}, 70%, 50%)`;

    function renderScores(scoresObj) {
      const wrap = document.getElementById('scores');
      wrap.innerHTML = '';
      if (!scoresObj) return;

      Object.entries(scoresObj).forEach(([label, val]) => {
        const tile = document.createElement('div');
        tile.className = 'metric';
        tile.style.color = hslForScore(val);

        tile.innerHTML = `
          <span class="value">${Number(val).toFixed(1)}</span>
          <span class="label">${label}</span>
          <div class="bar" style="width:${val}%;"></div>
        `;
        wrap.appendChild(tile);
      });
    }

    /* ---------- main click handler ---------- */
    document.getElementById('send').onclick = async () => {
      const ideaTxt = document.getElementById('idea').value.trim();
      if (!ideaTxt) return alert('Please type an idea first!');

      const btn    = document.getElementById('send');
      const status = document.getElementById('status');
      const answer = document.getElementById('answer');
      const scoresWrap = document.getElementById('scores');

      /* reset UI */
      scoresWrap.innerHTML = '';
      answer.textContent   = '';
      status.innerHTML     = '<span class="loading"></span> Submitting your idea...';
      btn.disabled = true;
      btn.textContent = 'Evaluating...';

      try {
        /* 1. submit idea */
        const r1   = await fetch(SUBMIT_URL, {
          method : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body   : JSON.stringify({ idea: ideaTxt })
        });
        const { jobId } = await r1.json();
        if (!jobId) throw new Error('Submission failed ☹︎');

        await new Promise(res => setTimeout(res, 1500));   // grace period

        /* 2. poll for results */
        let done = false, tries = 0;
        while (!done && tries < 60) {
          const r2   = await fetch(RESULT_URL + jobId);
          const raw  = await r2.json();
          const data = Array.isArray(raw) ? raw[0] : raw;   // <-- unwrap!

          if (data.status === 'done') {
            done = true;
            status.innerHTML = '<span class="success">✓</span> Evaluation completed!';
            renderScores(data.scores);
            answer.textContent = data.brief || JSON.stringify(data, null, 2);
            break;
          }

          status.innerHTML =
            `<span class="loading"></span> Analyzing your idea... (${++tries * 10}s)`;
          await new Promise(res => setTimeout(res, 10000)); // wait 10 s
        }

        if (!done) status.textContent = 'Timed out after 10 minutes ⏱';

      } catch (err) {
        status.textContent = `Error: ${err.message}`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Evaluate Idea';
      }
    };

    /* ---------- Ctrl+Enter shortcut ---------- */
    document.getElementById('idea').addEventListener('keydown', e => {
      if (e.key === 'Enter' && e.ctrlKey) document.getElementById('send').click();
    });
  </script>
</body>
</html>
