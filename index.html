<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ROO AI</title>

  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f1a; --panel:#0f1524; --muted:#9aa4b2; --text:#e6e9ef;
      --accent:#3E84C6; --accent-2:#6aa6da; --border:#1d2638;
      --good:#16a34a; --mid:#f59e0b; --bad:#ef4444;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'JetBrains Mono',monospace;
      background:
        radial-gradient(1200px 800px at 10% -10%, #12203a 0%, transparent 60%),
        radial-gradient(1200px 800px at 110% 110%, #0e1a2b 0%, transparent 60%),
        var(--bg);
      color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:32px;
    }
    .container{width:100%; max-width:780px; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:28px; box-shadow:0 8px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px; letter-spacing:.5px}
    .logo{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 0 0 1px rgba(62,132,198,.35), 0 6px 18px rgba(62,132,198,.25)}
    h1{font-size:18px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    label{display:block;margin:8px 0 8px 0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    textarea{
      width:100%;min-height:120px;resize:vertical;background:#0b1020;border:1px solid var(--border);border-radius:10px;
      color:var(--text);padding:14px;font-size:14px;line-height:1.5;transition:border-color .2s, box-shadow .2s;
    }
    textarea:focus{outline:none;border-color:#2b3c5a;box-shadow:0 0 0 3px rgba(62,132,198,.15)}
    .row{display:flex;gap:12px;margin-top:12px;min-width:0;}
    button{
      appearance:none;border:0;border-radius:10px;cursor:pointer;padding:12px 16px;font-size:14px;font-weight:600;
      background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#0b0f1a;flex:0 0 160px; box-shadow:0 6px 18px rgba(62,132,198,.25);
      transition:transform .15s ease, filter .2s ease;
    }
    button:hover{transform:translateY(-1px)}
    button:disabled{filter:grayscale(.4) brightness(.9);cursor:not-allowed}
    #status{
      flex:1;border:1px dashed var(--border);border-radius:10px;padding:12px 14px;font-size:13px;color:var(--muted);
      display:flex;align-items:center;gap:10px;min-height:44px;
      min-width:0;
    }
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.15);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress{height:8px;border-radius:6px;background:#0b1020;border:1px solid var(--border);margin-top:10px;overflow:hidden}
    .progress-inner{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .6s ease}

    /* metrics grid */
    .metrics{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:18px}
    @media (max-width:720px){.metrics{grid-template-columns:1fr}}

    .metric{
      position:relative;
      border:1px solid var(--border);border-radius:12px;background:#0b1020;
      padding:14px 14px 12px;display:grid;grid-template-columns:1fr auto;gap:8px 12px;
    }
    .metric .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .metric .value{font-size:22px;font-weight:700;line-height:1}
    .metric .chip{justify-self:start;grid-column:1/2;font-size:11px;color:#cdd6e3;background:#10182b;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    .meter{grid-column:1 / -1;height:6px;border-radius:5px;background:#0a1326;border:1px solid var(--border);overflow:hidden}
    .meter > i{display:block;height:100%;width:0%}
    .meter.good > i{background:linear-gradient(90deg,#0ea75a,#61d497)}
    .meter.mid > i {background:linear-gradient(90deg,#f59e0b,#ffd166)}
    .meter.bad > i {background:linear-gradient(90deg,#ef4444,#fb7185)}

    /* brief panel */
    #answer{margin-top:18px;border:1px solid var(--border);border-radius:12px;background:#0b1020;padding:18px}
    #answer .md-h2{font-size:14px;font-weight:700;margin:12px 0 6px;color:#cfd6e6}
    #answer p{margin:6px 0;font-size:13px;color:#d8dee9}
    #answer::-webkit-scrollbar{width:10px}
    #answer::-webkit-scrollbar-thumb{background:#16203a;border-radius:8px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* hover card (desktop hover; mobile uses click) */
    .hovercard{
      position:absolute; left:50%; bottom:calc(100% + 10px); transform:translate(-50%,6px);
      max-width:min(360px, calc(100% - 16px)); width:max-content;
      background:#0b1020; border:1px solid var(--border); border-radius:10px; padding:10px 12px;
      box-shadow:0 8px 24px rgba(0,0,0,.35); opacity:0; visibility:hidden;
      transition:opacity .15s ease, transform .15s ease; pointer-events:none; z-index:20;
    }
    .metric:hover .hovercard{opacity:1; visibility:visible; transform:translate(-50%,0)}
    .metric[aria-expanded="true"] .hovercard{
      opacity:1; visibility:visible; transform:translate(-50%,0); pointer-events:auto;
    }
    @media (hover:none){
      .metric:hover .hovercard{opacity:0; visibility:hidden; transform:translate(-50%,6px)}
      .metric[aria-expanded="true"] .hovercard{
        opacity:1; visibility:visible; transform:translate(-50%,0); pointer-events:auto;
      }
    }
    .hovercard h4{font-size:12px;font-weight:700;margin:0 0 6px;color:#cfd6e6;display:flex;align-items:center;gap:8px}
    .hovercard .badge{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:#10182b;color:#cdd6e3}
    .hovercard p{font-size:12px;color:#d8dee9;line-height:1.4;margin:4px 0 6px}
    .hovercard ul{margin-left:16px}
    .hovercard li{font-size:12px;color:#cbd5e1;margin:2px 0}

    /* investor-grade brief headings */
    #answer .md-h1{font-size:16px;font-weight:700;letter-spacing:.02em;margin:14px 0 6px;color:#e2e8f0}
    #answer .md-h3{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:#9aa4b2;margin:10px 0 4px}
    #answer .lead{font-size:13px;color:#d8dee9;margin:2px 0 8px}

    /* phone status sizing */
    @media (max-width:480px){
      button{flex:0 0 128px;padding:10px 12px;font-size:13px}
      #status{padding:10px 12px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    }
    @media (max-width:360px){
      button{flex:0 0 110px;padding:8px 10px;font-size:12px}
      #status{padding:8px 10px;font-size:11px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ROO AI</h1>
          <div class="sub">Idea Evaluation</div>
        </div>
      </div>
      <div class="sub">v1.2</div>
    </header>

    <label for="idea">Your Idea</label>
    <textarea id="idea" placeholder="Describe your startup idea in detail..."></textarea>

    <div class="row">
      <button id="send">Evaluate Idea</button>
      <div id="status"><span class="sr-only">Status:</span><span>Idle</span></div>
    </div>

    <div class="progress" aria-label="Progress">
      <div id="progressBar" class="progress-inner"></div>
    </div>

    <section id="scores" class="metrics" aria-label="Scores"></section>
    <section id="answer" aria-label="Brief"></section>
  </div>

  <script>
    const SUBMIT_URL = 'https://benzh88.app.n8n.cloud/webhook/6b09d0aa-a903-4239-a2bb-9cbff340c34a';
    const RESULT_URL = 'https://benzh88.app.n8n.cloud/webhook/a6e524b5-b6f5-452a-a7bd-82771d08c8af/result/';

    const hslForScore = s => `hsl(${Math.max(0, Math.min(120, s))}, 70%, 50%)`;

    const progressBar = document.getElementById('progressBar');
    let fakeProgress = 0;
    const PROGRESS_STEPS = [12, 30, 48, 66, 78, 90, 98];
    let progressStepIndex = 0;

    function setProgress(p){ fakeProgress = Math.max(fakeProgress, Math.min(p, 100)); progressBar.style.width = fakeProgress + '%'; }
    function resetProgress(){ fakeProgress = 0; progressStepIndex = 0; setProgress(0); }
    function tickProgressForInterval(intervalMs){
      const isTwoMinPhase = intervalMs >= 120000;
      const i = progressStepIndex;
      if (i < 5 && isTwoMinPhase){ setProgress(PROGRESS_STEPS[i]); progressStepIndex++; }
      else if (i >= 5 && i < 7 && intervalMs === 30000){ setProgress(PROGRESS_STEPS[i]); progressStepIndex++; }
    }

    function extractBrief(text){
      const marker = '## Snapshot';
      const i = text.indexOf(marker);
      return i === -1 ? text : text.slice(i).trimStart();
    }
    function escapeHTML(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function formatBriefToHTML(text){
      const SECTIONS = new Set([
        'Snapshot','Market & Growth','Consumer Trends','Competitor Landscape','Founderâ€“Market Fit',
        'Go-to-Market Hypotheses (2-week tests)','Vacancy Map & Wedge','Competitors (from sources)',
        'Top Risks & 2-Week Kill Tests','Sources'
      ]);

      const out = [];
      for (const raw of text.split(/\r?\n/)){
        const line = raw.trim();
        if (!line){ out.push(''); continue; }

        if (line.startsWith('## ')){
          out.push(`<div class="md-h1">${escapeHTML(line.slice(3))}</div>`);
          continue;
        }
        if (SECTIONS.has(line)){
          out.push(`<div class="md-h1">${escapeHTML(line)}</div>`);
          continue;
        }
        const m = line.match(/^[-â€¢]?\s*(?:\*\*)?(.+?)(?:\*\*)?\s+â€”\s+(.*)$/);
        if (m && m[1] && m[2] && m[1].length < 140){
          out.push(`<div class="md-h3">${escapeHTML(m[1])}</div>`);
          out.push(`<p class="lead">â€” ${escapeHTML(m[2])}</p>`);
          continue;
        }
        out.push(`<p>${escapeHTML(line)}</p>`);
      }
      return out.join('');
    }

    const ORDER = ['Benchmark','Sentiment','Growth','CompetitiveIntensity','CapitalIntensity','Overall'];
    function bandFor(val){
      if (val >= 70) return {k:'good', txt:'High'};
      if (val >= 40) return {k:'mid',  txt:'Medium'};
      return {k:'bad', txt:'Low'};
    }
    function animateValue(node, end, ms=900){
      const start = 0, t0 = performance.now();
      function step(t){
        const p = Math.min(1, (t - t0) / ms);
        node.textContent = (start + (end - start) * p).toFixed(1);
        if (p < 1) requestAnimationFrame(step);
        else node.textContent = end.toFixed(1);
      }
      requestAnimationFrame(step);
    }

    const KEY_TO_LABEL = {
      overall:'Overall',
      growth:'Growth',
      benchmark:'Benchmark',
      sentiment:'Sentiment',
      competitive:'CompetitiveIntensity',
      capital:'CapitalIntensity'
    };
    function toCardsArray(x){
      if (Array.isArray(x)) return x;
      if (typeof x === 'string') { try { const p = JSON.parse(x); return Array.isArray(p) ? p : []; } catch { return []; } }
      return [];
    }
    function indexCards(arr){
      const map = {};
      toCardsArray(arr).forEach(c=>{
        const lbl = KEY_TO_LABEL[(c.key||'').toLowerCase()];
        if (lbl) map[lbl] = c;
      });
      return map;
    }
    function makeHoverCard(card,label){
      const root = document.createElement('div');
      root.className = 'hovercard';
      const h4 = document.createElement('h4');
      h4.textContent = card.title || label;
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = card.badge || '';
      h4.appendChild(badge);
      root.appendChild(h4);
      if (card.summary){
        const p = document.createElement('p'); p.textContent = card.summary; root.appendChild(p);
      }
      if (Array.isArray(card.bullets) && card.bullets.length){
        const ul = document.createElement('ul');
        card.bullets.slice(0,2).forEach(b=>{ const li=document.createElement('li'); li.textContent=b; ul.appendChild(li); });
        root.appendChild(ul);
      }
      return root;
    }

    function renderScores(scores, cardsRaw){
      const wrap = document.getElementById('scores');
      wrap.innerHTML = '';
      if(!scores) return;

      const cardsMap = indexCards(cardsRaw);
      const keys = ORDER.filter(k => k in scores)
                        .concat(Object.keys(scores).filter(k => !ORDER.includes(k)));

      keys.forEach(label=>{
        const val = Number(scores[label]);
        const tile = document.createElement('div');
        tile.className = 'metric';
        tile.style.borderColor = '#1f2a44';

        const lbl = document.createElement('div');
        lbl.className = 'label';
        lbl.textContent = label;

        const valueEl = document.createElement('div');
        valueEl.className = 'value';
        valueEl.textContent = '0.0';
        valueEl.style.color = hslForScore(val);

        const band = bandFor(val);
        const chip = document.createElement('div');
        chip.className = 'chip';
        let chipText = band.txt;
        if (label === 'CompetitiveIntensity' || label === 'CapitalIntensity') {
          chipText = band.k === 'good' ? 'Low' : band.k === 'mid' ? 'Medium' : 'High';
        }
        chip.textContent = chipText;

        const meter = document.createElement('div');
        meter.className = 'meter ' + band.k;
        const fill = document.createElement('i');
        meter.appendChild(fill);

        const card = cardsMap[label];
        if (card) tile.appendChild(makeHoverCard(card,label));

        tile.appendChild(lbl);
        tile.appendChild(valueEl);
        tile.appendChild(chip);
        tile.appendChild(meter);
        wrap.appendChild(tile);

        // Toggle on click only (mobile-friendly). No outside/blur logic.
        tile.setAttribute('role','button');
        tile.setAttribute('tabindex','0');
        tile.setAttribute('aria-expanded','false');

        function toggleTile(e){
          e.stopPropagation();
          const open = tile.getAttribute('aria-expanded') === 'true';
          // close others, then toggle this one
          document.querySelectorAll('.metric[aria-expanded="true"]').forEach(el=>{
            if (el !== tile) el.setAttribute('aria-expanded','false');
          });
          tile.setAttribute('aria-expanded', String(!open));
        }
        tile.addEventListener('click', toggleTile);
        tile.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleTile(e); }
          if (e.key === 'Escape') { tile.setAttribute('aria-expanded','false'); }
        });

        // Add click outside handler for mobile
        document.addEventListener('click', (e) => {
          if (!tile.contains(e.target)) {
            tile.setAttribute('aria-expanded', 'false');
          }
        });

        requestAnimationFrame(()=>{ fill.style.width = Math.max(0, Math.min(100, val)) + '%'; });
        animateValue(valueEl, val, 1000);
      });
    }

    // ---- main flow ----
    document.getElementById('send').onclick = async () => {
      const idea = document.getElementById('idea').value.trim();
      if(!idea) return alert('Please type an idea first.');

      const btn    = document.getElementById('send');
      const status = document.getElementById('status');
      const answer = document.getElementById('answer');
      const scores = document.getElementById('scores');

      scores.innerHTML = '';
      answer.textContent = '';
      resetProgress();
      status.innerHTML = `<span class="spinner" aria-hidden="true"></span><span>Submitting...</span>`;
      btn.disabled = true; btn.textContent = 'Evaluatingâ€¦';

      try{
        const r1 = await fetch(SUBMIT_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ idea })
        });
        const { jobId } = await r1.json();
        if(!jobId) throw new Error('No job id returned');

        await new Promise(res=>setTimeout(res,1100));

        let done = false, tries = 0;
        const t0 = Date.now();

        while(!done && tries < 60){
          const url = RESULT_URL + jobId + `?poll=${tries}`;
          const r2 = await fetch(url, { cache:'no-store' });

          if (r2.status !== 304){
            const raw  = await r2.json();
            const data = Array.isArray(raw) ? raw[0] : raw;

            if (data.status === 'done'){
              done = true;
              status.innerHTML = `<span>Completed</span>`;
              setProgress(100);
              renderScores(data.scores, data.cards);
              const brief = extractBrief(data.brief || '');
              answer.innerHTML = formatBriefToHTML(brief);
              break;
            }
          }

          const elapsed = Date.now() - t0;
          const intervalMs = elapsed < 10*60*1000 ? 120000 : 30000;
          status.innerHTML = `<span class="spinner" aria-hidden="true"></span><span>Processingâ€¦</span>`;
          await new Promise(res=>setTimeout(res, intervalMs));
          tickProgressForInterval(intervalMs);
          tries++;
        }

        if(!done){
          status.innerHTML = `<span>Timed out after ~36 minutes</span>`;
        }

      }catch(err){
        status.innerHTML = `<span>Error: ${err.message}</span>`;
      }finally{
        btn.disabled = false; btn.textContent = 'Evaluate Idea';
      }
    };

    document.getElementById('idea').addEventListener('keydown',e=>{
      if(e.key==='Enter' && e.ctrlKey) document.getElementById('send').click();
    });
  </script>
</body>
</html>
