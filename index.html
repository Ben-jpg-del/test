<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ROO AI</title>

  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:'JetBrains Mono',monospace;
      background:linear-gradient(135deg,#000 0%,#04045E 50%,#023E89 100%);
      min-height:100vh;color:#C0C0C0;
    }

    /* App shell (full screen on desktop) */
    .app{
      min-height:100vh;
      display:flex;flex-direction:column;
      max-width:1200px;margin:0 auto;padding:12px 16px;
    }

    /* Header with brand + thinking state */
    .chat-header{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;padding:8px 4px 12px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .avatar{
      width:36px;height:36px;border-radius:50%;
      background:rgba(0,0,0,.35);border:1px solid #3E84C6;
      display:grid;place-items:center;overflow:hidden;
      box-shadow:0 8px 20px rgba(0,0,0,.25);
    }
    .avatar svg{width:100%;height:100%;display:block}
    .title{
      font-weight:700;font-size:1.15rem;letter-spacing:.5px;
      background:linear-gradient(45deg,#C0C0C0,#3E84C6);
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
      text-shadow:0 0 20px rgba(62,132,198,.45);
    }

    .thinking{
      display:flex;align-items:center;gap:10px;min-height:28px;
    }
    .thinking .icon{filter:drop-shadow(0 0 6px rgba(62,132,198,.6))}
    #status{
      font-size:.95rem;min-width:140px;
    }

    /* Progress bar lives beside thinking text */
    .progress{
      width:180px;height:8px;border:1px solid #3E84C6;border-radius:6px;
      background:rgba(62,132,198,.15);overflow:hidden;
      box-shadow:inset 0 0 8px rgba(62,132,198,.25);
    }
    .progress-inner{
      height:100%;width:0%;background:linear-gradient(90deg,#3E84C6,#7db6ea);
      transition:width .6s ease;
    }

    /* Chat stream */
    .chat{
      flex:1;overflow:auto;border:1px solid rgba(62,132,198,.35);
      border-radius:16px;background:rgba(0,0,0,.35);backdrop-filter:blur(8px);
      padding:14px;display:flex;flex-direction:column;gap:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.25) inset;
    }
    .message{display:flex;gap:10px;align-items:flex-end;max-width:100%}
    .message.user{justify-content:flex-end}
    .bubble{
      padding:12px 14px;border-radius:14px;max-width:min(820px,100%);
      line-height:1.55;border:1px solid #3E84C6;background:rgba(0,0,0,.5);
      box-shadow:0 8px 20px rgba(0,0,0,.25);
      white-space:pre-wrap;word-break:break-word;
    }
    .message.user .bubble{
      background:rgba(62,132,198,.12);border-color:#7db6ea;
    }

    /* Composer row */
    .composer{
      display:flex;align-items:flex-end;gap:10px;margin-top:12px;
      position:sticky;bottom:0;padding-top:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.25));
    }
    .composer .avatar{flex:0 0 36px}
    .composer-box{flex:1;display:flex;gap:8px;align-items:flex-end}
    textarea{
      flex:1;min-height:54px;max-height:180px;resize:vertical;
      padding:12px;border:2px solid #3E84C6;border-radius:12px;
      background:rgba(0,0,0,.6);color:#C0C0C0;font-size:15px;transition:.3s;
    }
    textarea:focus{outline:none;border-color:#C0C0C0;box-shadow:0 0 18px rgba(192,192,192,.25)}

    button{
      padding:12px 16px;font-size:1rem;font-weight:600;
      background:linear-gradient(45deg,#023E89,#3E84C6);color:#C0C0C0;
      border:none;border-radius:10px;cursor:pointer;transition:.25s;text-transform:uppercase;
    }
    button:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(62,132,198,.35)}
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}

    /* Metrics + brief inside a bot bubble */
    .metrics{display:flex;flex-wrap:wrap;gap:14px;margin-top:6px}
    .metric{
      flex:1 1 130px;position:relative;padding:14px 10px 12px;
      border:2px solid currentColor;border-radius:12px;text-align:center;
      background:rgba(0,0,0,.45);backdrop-filter:blur(6px);transition:.25s;
    }
    .metric .symbol{display:block;font-size:1.3em;line-height:1;margin-bottom:6px;filter:drop-shadow(0 0 6px rgba(62,132,198,.4))}
    .metric .value{font-size:1.7em;font-weight:700}
    .metric .label{font-size:.72rem;letter-spacing:1px;text-transform:uppercase;opacity:.75;margin-top:4px;display:block}
    .metric .bar{position:absolute;left:0;bottom:0;height:3px;background:currentColor;border-radius:0 0 10px 10px}

    #answer{margin-top:14px;padding:14px;border-radius:10px;background:rgba(0,0,0,.35);border:1px solid #3E84C6;max-height:420px;overflow:auto;opacity:1;transform:none}
    #answer .md-h2{font-size:1.1em;font-weight:700;margin:10px 0 6px}
    #answer p{margin:6px 0}
    #answer::-webkit-scrollbar{width:8px}
    #answer::-webkit-scrollbar-thumb{background:#3E84C6;border-radius:4px}
    #answer::-webkit-scrollbar-thumb:hover{background:#C0C0C0}

    .loading{display:inline-block;width:18px;height:18px;border:3px solid rgba(192,192,192,.3);border-radius:50%;border-top-color:#3E84C6;animation:spin 1s infinite linear}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:768px){
      .app{padding:8px}
      .progress{width:120px}
      textarea{min-height:48px}
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Header -->
    <div class="chat-header">
      <div class="brand">
        <div class="avatar" title="ROO — Risk · Odds · Opportunity" aria-label="ROO AI">
          <!-- ROO SVG -->
          <svg viewBox="0 0 64 64" role="img" aria-hidden="true">
            <defs>
              <linearGradient id="rooGrad" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%"  stop-color="#3E84C6"/>
                <stop offset="100%" stop-color="#023E89"/>
              </linearGradient>
            </defs>
            <circle cx="32" cy="32" r="30" fill="rgba(0,0,0,.30)" stroke="url(#rooGrad)" stroke-width="2"/>
            <text x="12" y="39" font-family="JetBrains Mono, monospace" font-weight="700" font-size="28" fill="url(#rooGrad)">R</text>
            <circle cx="41.5" cy="24" r="7" fill="none" stroke="#7DB6EA" stroke-width="3"/>
            <circle cx="48.5" cy="33" r="7" fill="none" stroke="url(#rooGrad)" stroke-width="3" opacity="0.95"/>
            <path d="M38 42 L52 28" stroke="#7DB6EA" stroke-width="2.5" stroke-linecap="round"/>
            <polyline points="49,27 52,27 52,30" fill="none" stroke="#7DB6EA" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="title">ROO AI</div>
      </div>

      <div class="thinking" aria-live="polite">
        <span class="icon">💡</span>
        <span id="status"></span>
        <div class="progress" aria-label="Progress">
          <div id="progressBar" class="progress-inner"></div>
        </div>
      </div>
    </div>

    <!-- Chat stream -->
    <div id="chat" class="chat" role="log" aria-live="polite">
      <!-- User’s prompt bubble appears after submit -->
      <!-- Results bubble (scores + brief) -->
      <div id="resultBubble" class="message bot" style="display:none">
        <div class="bubble" style="width:100%">
          <div id="scores" class="metrics"></div>
          <div id="answer"></div>
        </div>
      </div>
    </div>

    <!-- Composer -->
    <div class="composer">
      <div class="avatar" title="ROO — Risk · Odds · Opportunity" aria-hidden="true">
        <!-- ROO SVG (same as header) -->
        <svg viewBox="0 0 64 64" role="img" aria-hidden="true">
          <defs>
            <linearGradient id="rooGrad2" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%"  stop-color="#3E84C6"/>
              <stop offset="100%" stop-color="#023E89"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="30" fill="rgba(0,0,0,.30)" stroke="url(#rooGrad2)" stroke-width="2"/>
          <text x="12" y="39" font-family="JetBrains Mono, monospace" font-weight="700" font-size="28" fill="url(#rooGrad2)">R</text>
          <circle cx="41.5" cy="24" r="7" fill="none" stroke="#7DB6EA" stroke-width="3"/>
          <circle cx="48.5" cy="33" r="7" fill="none" stroke="url(#rooGrad2)" stroke-width="3" opacity="0.95"/>
          <path d="M38 42 L52 28" stroke="#7DB6EA" stroke-width="2.5" stroke-linecap="round"/>
          <polyline points="49,27 52,27 52,30" fill="none" stroke="#7DB6EA" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <div class="composer-box">
        <textarea id="idea" placeholder="Describe your startup idea in detail..."></textarea>
        <button id="send">Evaluate Idea</button>
      </div>
    </div>
  </div>

  <script>
    const SUBMIT_URL = 'https://benzh88.app.n8n.cloud/webhook/6b09d0aa-a903-4239-a2bb-9cbff340c34a';
    const RESULT_URL = 'https://benzh88.app.n8n.cloud/webhook/a6e524b5-b6f5-452a-a7bd-82771d08c8af/result/';

    const hslForScore = s => `hsl(${Math.max(0, Math.min(120, s))}, 70%, 50%)`;

    // Progress helpers (unchanged logic, IDs preserved)
    const progressBar = document.getElementById('progressBar');
    let fakeProgress = 0;
    const PROGRESS_STEPS = [20, 40, 60, 80, 95, 99];
    let progressStepIndex = 0;

    function setProgress(p){
      fakeProgress = Math.max(fakeProgress, Math.min(p, 100));
      progressBar.style.width = fakeProgress + '%';
    }
    function resetProgress(){
      fakeProgress = 0; progressStepIndex = 0; setProgress(0);
    }
    function tickProgressForInterval(intervalMs){
      const isTwoMinPhase = intervalMs >= 120000;
      const i = progressStepIndex;
      if (i < 4 && isTwoMinPhase){ setProgress(PROGRESS_STEPS[i]); progressStepIndex++; }
      else if (i >= 4 && i < 6 && intervalMs === 30000){ setProgress(PROGRESS_STEPS[i]); progressStepIndex++; }
    }

    // Score tiles (unchanged)
    const SYMBOLS = {
      Benchmark:['📈','🏁','💹','📊'],
      Sentiment:['🧠','💬','🙂','🔍'],
      Growth:['🌱','🚀','📈','🌿'],
      CompetitiveIntensity:['🥊','⚔️','🏟️','🧩'],
      CapitalIntensity:['🏗️','🧰','🏭','🔧'],
      Overall:['⭐','🏆','🎯','✨']
    };
    const ORDER = ['Benchmark','Sentiment','Growth','CompetitiveIntensity','CapitalIntensity','Overall'];

    function animateValue(node, end, ms=1000){
      const start = 0, t0 = performance.now();
      function step(t){
        const p = Math.min(1, (t - t0) / ms);
        const val = start + (end - start) * p;
        node.textContent = val.toFixed(1);
        if(p < 1) requestAnimationFrame(step);
        else node.textContent = end.toFixed(1);
      }
      requestAnimationFrame(step);
    }

    function renderScores(scores){
      const wrap = document.getElementById('scores');
      wrap.innerHTML = '';
      if(!scores) return;

      const keys = ORDER.filter(k => Object.prototype.hasOwnProperty.call(scores,k))
                        .concat(Object.keys(scores).filter(k => !ORDER.includes(k)));

      keys.forEach((label)=>{
        const val = Number(scores[label]);
        const tile = document.createElement('div');
        tile.className = 'metric';
        tile.style.color = hslForScore(val);

        const symbol = document.createElement('span');
        symbol.className = 'symbol';
        const pool = SYMBOLS[label] || ['🎰','✨','🔄','🎲'];
        symbol.textContent = pool[0];

        const valueEl = document.createElement('span');
        valueEl.className = 'value';
        valueEl.textContent = '0.0';

        const lbl = document.createElement('span');
        lbl.className = 'label';
        lbl.textContent = label;

        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.width = '0%';

        tile.appendChild(symbol);
        tile.appendChild(valueEl);
        tile.appendChild(lbl);
        tile.appendChild(bar);
        wrap.appendChild(tile);

        requestAnimationFrame(()=>{ bar.style.width = val + '%'; });
        animateValue(valueEl, val, 1100);
      });
    }

    function extractBrief(text){
      const marker = '## Snapshot';
      const idx = text.indexOf(marker);
      return idx === -1 ? text : text.slice(idx).trimStart();
    }

    function escapeHTML(s){
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function formatBriefToHTML(text){
      const lines = text.split(/\r?\n/);
      return lines.map(line=>{
        if(/^##\s+/.test(line)){
          const title = escapeHTML(line.replace(/^##\s+/, '').trim());
          return `<div class="md-h2">${title}</div>`;
        }
        if(line.trim()==='') return '';
        return `<p>${escapeHTML(line)}</p>`;
      }).join('');
    }

    // Chat helpers (display-only)
    const chat = document.getElementById('chat');
    function addUserBubble(text){
      const row = document.createElement('div');
      row.className = 'message user';
      row.innerHTML = `<div class="bubble">${escapeHTML(text)}</div>`;
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }
    function showResultBubble(){ document.getElementById('resultBubble').style.display = 'flex'; chat.scrollTop = chat.scrollHeight; }

    document.getElementById('send').onclick = async () => {
      const idea = document.getElementById('idea').value.trim();
      if(!idea) return alert('Please type an idea first!');

      const btn = document.getElementById('send');
      const status = document.getElementById('status');
      const answer = document.getElementById('answer');
      const scores = document.getElementById('scores');

      addUserBubble(idea);
      scores.innerHTML = '';
      answer.textContent = '';
      resetProgress();
      status.innerHTML  = '<span class="loading" aria-hidden="true"></span> Submitting…';
      btn.disabled = true; btn.textContent = 'Evaluating…';

      try{
        const r1 = await fetch(SUBMIT_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ idea })
        });
        const { jobId } = await r1.json();
        if(!jobId) throw new Error('Submission failed');

        await new Promise(res=>setTimeout(res,1500));

        let done = false, tries = 0;
        const pollStart = Date.now();

        while(!done && tries < 60){
          const url = RESULT_URL + jobId + `?poll=${tries}`;
          const r2  = await fetch(url, { cache: 'no-store' });

          if (r2.status !== 304) {
            const raw  = await r2.json();
            const data = Array.isArray(raw)?raw[0]:raw;

            if(data.status === 'done'){
              done = true;
              status.textContent = 'Completed';
              setProgress(100);
              renderScores(data.scores);
              const brief = extractBrief(data.brief || '');
              answer.innerHTML = formatBriefToHTML(brief);
              showResultBubble();
              break;
            }
          }

          const elapsed = Date.now() - pollStart;
          const intervalMs = elapsed < 8 * 60 * 1000 ? 120000 : 30000;
          status.innerHTML = '<span class="loading" aria-hidden="true"></span> Thinking…';

          await new Promise(res=>setTimeout(res, intervalMs));
          tickProgressForInterval(intervalMs);

          tries++;
        }

        if(!done) document.getElementById('status').textContent = 'Timed out';

      }catch(err){
        document.getElementById('status').textContent = `Error: ${err.message}`;
      }finally{
        const btn = document.getElementById('send');
        btn.disabled = false; btn.textContent = 'Evaluate Idea';
      }
    };

    document.getElementById('idea').addEventListener('keydown',e=>{
      if(e.key==='Enter' && e.ctrlKey) document.getElementById('send').click();
    });
  </script>
</body>
</html>
