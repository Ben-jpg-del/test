<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ROO AI</title>

  <!-- Google Fonts: JetBrains Mono -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}

    /* page shell */
    body{
      font-family:'JetBrains Mono',monospace;
      background:linear-gradient(135deg,#000 0%,#04045E 50%,#023E89 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;
      padding:20px;color:#C0C0C0;
    }

    /* glass canvas */
    .container{
      background:rgba(0,0,0,.8);backdrop-filter:blur(10px);
      border:1px solid #3E84C6;border-radius:20px;
      padding:24px;max-width:960px;width:100%;
      box-shadow:0 20px 40px rgba(0,0,0,.3);position:relative;overflow:hidden;
      display:flex;flex-direction:column;min-height:70vh;
    }
    .container::before{
      content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(62,132,198,.08),transparent);
      animation:shimmer 3s infinite;
    }
    @keyframes shimmer{0%{left:-100%;}100%{left:100%}}

    h1{
      text-align:center;margin-bottom:16px;font-size:2rem;font-weight:700;
      background:linear-gradient(45deg,#C0C0C0,#3E84C6);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
      text-shadow:0 0 30px rgba(62,132,198,.5);
      animation:glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow{from{text-shadow:0 0 30px rgba(62,132,198,.5);}
                    to  {text-shadow:0 0 40px rgba(62,132,198,.8)} }

    /* CHAT LAYOUT */
    .chat{
      display:flex;flex-direction:column;gap:14px;flex:1;min-height:0;
    }
    .messages{
      flex:1;overflow:auto;padding:6px 4px 6px;display:flex;flex-direction:column;gap:12px;
    }
    .message{display:flex;gap:10px;align-items:flex-end;}
    .message.user{justify-content:flex-end;}
    .message.assistant{justify-content:flex-start;}

    .avatar{
      width:28px;height:28px;border-radius:50%;
      background:linear-gradient(45deg,#3E84C6,#023E89);flex:0 0 28px;
      display:flex;align-items:center;justify-content:center;font-size:14px;color:#C0C0C0;
      box-shadow:0 0 0 1px rgba(62,132,198,.5) inset;
    }

    .bubble{
      max-width:720px;padding:14px 16px;border-radius:16px;border:1px solid #3E84C6;
      background:rgba(0,0,0,.45);box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    .user .bubble{
      background:linear-gradient(135deg,rgba(2,62,137,.75),rgba(62,132,198,.55));
      border-color:#7db6ea;
    }

    /* Composer (kept IDs, just styled like chat box) */
    .composer{
      display:flex;gap:10px;margin-top:10px;align-items:flex-end;
      border-top:1px solid rgba(62,132,198,.25);padding-top:10px;
    }
    label{display:none;} /* hide label in chat mode */
    textarea{
      width:100%;height:80px;padding:12px;border:2px solid #3E84C6;border-radius:12px;
      background:rgba(0,0,0,.6);color:#C0C0C0;font-size:15px;resize:vertical;transition:.3s;
    }
    textarea:focus{outline:none;border-color:#C0C0C0;box-shadow:0 0 20px rgba(192,192,192,.2);}
    button{
      padding:12px 18px;font-size:1em;font-weight:600;
      background:linear-gradient(45deg,#023E89,#3E84C6);color:#C0C0C0;border:none;border-radius:10px;
      cursor:pointer;transition:.3s;letter-spacing:.5px;
    }
    button:hover{
      transform:translateY(-2px);box-shadow:0 10px 25px rgba(62,132,198,.35);
      background:linear-gradient(45deg,#3E84C6,#023E89);
    }
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}

    /* Status row now IN the assistant bubble + inline progress */
    .status-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
    .status-icon{font-size:18px;filter:drop-shadow(0 0 6px rgba(62,132,198,.5));}
    #status{
      padding:0;border-radius:6px;text-align:left;min-height:auto;background:none;border:none;
      animation:pulse 2s infinite;color:#C0C0C0;
    }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.75}}

    .progress{height:8px;border:1px solid #3E84C6;border-radius:6px;
      background:rgba(62,132,198,.15);overflow:hidden;box-shadow:inset 0 0 8px rgba(62,132,198,.25);
      width:180px; /* compact to sit inline with status */
    }
    .progress-inner{height:100%;width:0%;background:linear-gradient(90deg,#3E84C6,#7db6ea);transition:width .6s ease;}

    /* Keep tiles & answer styles; just look like content inside assistant bubble */
    .metrics{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px;}
    .metric{
      flex:1 1 120px;position:relative;padding:14px 10px;border:2px solid currentColor;border-radius:12px;
      text-align:center;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);transition:.25s;
    }
    .metric:hover{transform:translateY(-4px)}
    .metric .symbol{display:block;font-size:1.25em;line-height:1;margin-bottom:6px;filter:drop-shadow(0 0 6px rgba(62,132,198,.4));}
    .metric .symbol.spin{animation:spin 0.8s linear infinite;}
    .metric .value{font-size:1.6em;font-weight:700;}
    .metric .label{font-size:.7em;letter-spacing:1px;text-transform:uppercase;opacity:.75;margin-top:6px;display:block;}
    .metric .bar{position:absolute;left:0;bottom:0;height:4px;background:currentColor;border-radius:0 0 10px 10px;}
    @keyframes spin{to{transform:rotate(360deg)}}

    #answer{
      margin-top:12px;padding:16px;border-radius:10px;background:rgba(0,0,0,.35);
      border:1px solid #3E84C6;line-height:1.6;max-height:380px;overflow-y:auto;
      opacity:0;transform:translateY(10px);transition:.4s;white-space:normal;
    }
    #answer:not(:empty){opacity:1;transform:translateY(0)}
    #answer::-webkit-scrollbar{width:8px;}
    #answer::-webkit-scrollbar-thumb{background:#3E84C6;border-radius:4px;}
    #answer::-webkit-scrollbar-thumb:hover{background:#C0C0C0;}
    #answer .md-h2{font-size:1.1em;font-weight:700;margin:12px 0 6px}
    #answer p{margin:6px 0}

    @media(max-width:768px){
      .container{padding:20px 16px;margin:10px}
      h1{font-size:1.6rem}
      textarea{height:90px}
      .progress{width:120px}
    }

    /* Desktop-only full-screen container (kept from prior change) */
    @media(min-width:769px){
      body{ padding:0; }
      .container{ max-width:none;width:100%;min-height:100vh;border-radius:0; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ROO AI</h1>

    <div class="chat">
      <div id="messages" class="messages">
        <!-- Messages will be appended here -->
        <div class="message assistant">
          <div class="avatar">ü§ñ</div>
          <div class="bubble">
            <div class="status-row">
              <span class="status-icon">‚öôÔ∏è</span>
              <div id="status"></div>
              <div class="progress" aria-label="Progress"><!-- moved inline -->
                <div id="progressBar" class="progress-inner"></div>
              </div>
            </div>

            <div id="scores" class="metrics"></div>
            <div id="answer"></div>
          </div>
        </div>
      </div>

      <!-- Composer -->
      <div class="composer">
        <label for="idea">Your Idea</label>
        <textarea id="idea" placeholder="Describe your startup idea in detail..."></textarea>
        <button id="send">Evaluate Idea</button>
      </div>
    </div>
  </div>

  <script>
    const SUBMIT_URL = 'https://benzh88.app.n8n.cloud/webhook/6b09d0aa-a903-4239-a2bb-9cbff340c34a';
    const RESULT_URL = 'https://benzh88.app.n8n.cloud/webhook/a6e524b5-b6f5-452a-a7bd-82771d08c8af/result/';

    const hslForScore = s => `hsl(${Math.max(0, Math.min(120, s))}, 70%, 50%)`;

    // ---------- fake progress helpers ----------
    const progressBar = document.getElementById('progressBar');
    let fakeProgress = 0;
    const PROGRESS_STEPS = [20, 40, 60, 80, 95, 99];
    let progressStepIndex = 0;

    function setProgress(p){
      fakeProgress = Math.max(fakeProgress, Math.min(p, 100));
      progressBar.style.width = fakeProgress + '%';
    }
    function resetProgress(){
      fakeProgress = 0;
      progressStepIndex = 0;
      setProgress(0);
    }
    function tickProgressForInterval(intervalMs){
      const isTwoMinPhase = intervalMs >= 120000;
      const applyingIndex = progressStepIndex;

      if (applyingIndex < 4 && isTwoMinPhase){
        setProgress(PROGRESS_STEPS[applyingIndex]);
        progressStepIndex++;
      } else if (applyingIndex >= 4 && applyingIndex < 6 && intervalMs === 30000){
        setProgress(PROGRESS_STEPS[applyingIndex]);
        progressStepIndex++;
      }
    }

    // ---------- slot/symbol helpers ----------
    const SYMBOLS = {
      Benchmark:['üìà','üèÅ','üíπ','üìä'],
      Sentiment:['üß†','üí¨','üôÇ','üîç'],
      Growth:['üå±','üöÄ','üìà','üåø'],
      CompetitiveIntensity:['ü•ä','‚öîÔ∏è','üèüÔ∏è','üß©'],
      CapitalIntensity:['üèóÔ∏è','üß∞','üè≠','üîß'],
      Overall:['‚≠ê','üèÜ','üéØ','‚ú®']
    };
    const ORDER = ['Benchmark','Sentiment','Growth','CompetitiveIntensity','CapitalIntensity','Overall'];

    function animateValue(node, end, ms=1000){
      const start = 0;
      const t0 = performance.now();
      function step(t){
        const p = Math.min(1, (t - t0) / ms);
        const val = start + (end - start) * p;
        node.textContent = val.toFixed(1);
        if(p < 1) requestAnimationFrame(step);
        else node.textContent = end.toFixed(1);
      }
      requestAnimationFrame(step);
    }

    function renderScores(scores){
      const wrap = document.getElementById('scores');
      wrap.innerHTML = '';
      if(!scores) return;

      const keys = ORDER.filter(k => Object.prototype.hasOwnProperty.call(scores,k))
                        .concat(Object.keys(scores).filter(k => !ORDER.includes(k)));

      keys.forEach((label)=>{
        const val = Number(scores[label]);
        const tile = document.createElement('div');
        tile.className = 'metric';
        tile.style.color = hslForScore(val);

        const symbol = document.createElement('span');
        symbol.className = 'symbol spin';
        const pool = SYMBOLS[label] || ['üé∞','‚ú®','üîÑ','üé≤'];
        symbol.textContent = pool[Math.floor(Math.random()*pool.length)];

        const valueEl = document.createElement('span');
        valueEl.className = 'value';
        valueEl.textContent = '0.0';

        const lbl = document.createElement('span');
        lbl.className = 'label';
        lbl.textContent = label;

        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.width = '0%';

        tile.appendChild(symbol);
        tile.appendChild(valueEl);
        tile.appendChild(lbl);
        tile.appendChild(bar);
        wrap.appendChild(tile);

        const shuffleAll = [].concat(...Object.values(SYMBOLS));
        const shuffle = setInterval(()=>{
          symbol.textContent = shuffleAll[Math.floor(Math.random()*shuffleAll.length)];
        }, 90);

        setTimeout(()=>{
          clearInterval(shuffle);
          symbol.textContent = pool[0];
          symbol.classList.remove('spin');
        }, 1200);

        requestAnimationFrame(()=>{ bar.style.width = val + '%'; });
        animateValue(valueEl, val, 1100);
      });
    }

    function extractBrief(text){
      const marker = '## Snapshot';
      const idx    = text.indexOf(marker);
      return idx === -1 ? text : text.slice(idx).trimStart();
    }

    function escapeHTML(s){
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
              .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function formatBriefToHTML(text){
      const lines = text.split(/\r?\n/);
      const html = lines.map(line=>{
        if(/^##\s+/.test(line)){
          const title = escapeHTML(line.replace(/^##\s+/, '').trim());
          return `<div class="md-h2">${title}</div>`;
        }
        if(line.trim()==='') return '';
        return `<p>${escapeHTML(line)}</p>`;
      }).join('');
      return html;
    }

    // Append a user bubble on submit (display only)
    function addUserMessage(text){
      const messages = document.getElementById('messages');
      const msg = document.createElement('div');
      msg.className = 'message user';
      msg.innerHTML = `
        <div class="bubble">${escapeHTML(text)}</div>
        <div class="avatar">üßë</div>
      `;
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    document.getElementById('send').onclick = async () => {
      const idea = document.getElementById('idea').value.trim();
      if(!idea) return alert('Please type an idea first!');

      addUserMessage(idea);

      const btn    = document.getElementById('send');
      const status = document.getElementById('status');
      const answer = document.getElementById('answer');
      const scores = document.getElementById('scores');

      scores.innerHTML = '';
      answer.textContent = '';
      resetProgress();
      status.textContent  = 'Submitting your idea...';
      btn.disabled = true; btn.textContent = 'Evaluating...';

      try{
        const r1 = await fetch(SUBMIT_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ idea })
        });
        const { jobId } = await r1.json();
        if(!jobId) throw new Error('Submission failed ‚òπÔ∏é');

        await new Promise(res=>setTimeout(res,1500));

        let done = false, tries = 0;
        const pollStart = Date.now();

        while(!done && tries < 60){
          const url = RESULT_URL + jobId + `?poll=${tries}`;
          const r2  = await fetch(url, { cache: 'no-store' });

          if (r2.status !== 304) {
            const raw  = await r2.json();
            const data = Array.isArray(raw)?raw[0]:raw;

            if(data.status === 'done'){
              done = true;
              status.textContent = 'Evaluation completed!';
              setProgress(100);
              renderScores(data.scores);
              const brief = extractBrief(data.brief || '');
              answer.innerHTML = formatBriefToHTML(brief);

              // scroll to latest content
              const messages = document.getElementById('messages');
              messages.scrollTop = messages.scrollHeight;
              break;
            }
          }

          const elapsed = Date.now() - pollStart;
          const intervalMs = elapsed < 8 * 60 * 1000 ? 120000 : 30000;
          status.textContent = 'Working...';

          await new Promise(res=>setTimeout(res, intervalMs));
          tickProgressForInterval(intervalMs);

          tries++;
        }

        if(!done) document.getElementById('status').textContent = 'Timed out after ~36 minutes ‚è±';

      }catch(err){
        document.getElementById('status').textContent = `Error: ${err.message}`;
      }finally{
        const btn = document.getElementById('send');
        btn.disabled = false; btn.textContent = 'Evaluate Idea';
      }
    };

    document.getElementById('idea').addEventListener('keydown',e=>{
      if(e.key==='Enter' && e.ctrlKey) document.getElementById('send').click();
    });
  </script>
</body>
</html>
